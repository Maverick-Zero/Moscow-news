!function(t){function e(t,e){this._handlers=this._handlers||[],this._handlers.push({cb:t,ctx:e||this})}function i(){var t,e,i=this._handlers||[];for(e=0;e<i.length;e++)t=i[e],t.cb.apply(t.ctx,arguments)}function n(){function t(){r._disabled||(r._tick(),s++,e=Date.now()-n-s*i,window.setTimeout(t,Math.max(i-e,50)))}var e,i=1e3,n=Date.now(),s=0;window.setTimeout(t,i)}var r=t.Timer=function(e,i){this._interval=t.isNumber(e)&&e>0?e:0,this._repeat=i,r.onTick(this._onTick,this)},s=r.prototype;s.onAlarm=function(t,i){return e.call(this,t,i),this},s._onTick=function(t){if(this._interval)return this._repeat?void(t%this._interval==0&&i.call(this,t)):void(this._interval===t&&i.call(this,t))},r._ticks=0,r._started=!1,r.init=function(t){t&&t>0&&(this._ticks=t)},r.start=function(){this._started=!0},r.stop=function(){this._started=!1},r.disable=function(){this._disabled=!0},r.onTick=function(t,i){e.call(this,t,i)},r._tick=function(){!this._disabled&&this._started&&(this._ticks++,i.call(this,this._ticks))},t.isTest?r.run=n:n()}(window.Sandbox),function(t){var e=t.Sandbox=t.Sandbox||function(e){this.init?this.init(e):t.console&&t.console.error&&t.console.error("Sandbox was just declared but init is not defined yet")};e.ENV={PRODUCTION:"production",TESTING:"testing",DEVELOPMENT:"development"},e.static=function(e){e.call(t.Sandbox,t,document)},e.isString=function(t){return"string"==typeof t},e.getEnv=function(){return e.StaticLinks&&e.StaticLinks.BUCKET&&e.StaticLinks.BUCKET.env?e.StaticLinks.BUCKET.env:e.ENV.PRODUCTION},e._getContainer=function(t){var i;return t&&t.container instanceof HTMLElement&&(i=t.container),t&&e.isString(t.container)&&(i=document.querySelector(t.container)),i||(i=document.body),i}}(window),Sandbox.static(function(){var t=window.Sandbox,e=t.Counter=function(t){this.params=t},i=e.prototype;i.hit=function(t,e){if(t.path){var i=this._getUrl(t,e);this._makeReq(i)}},i._makeReq=function(t){window.parent.postMessage("sandbox-counter:"+t,"*")},i._getUrl=function(i,n){var r={reqid:this.params.reqid,rnd:this._getRnd(2),yuid:this.params.yuid?this.params.yuid:"${yuid}"};return i.login&&(i.login=this.params.login?this.params.login:"${login}"),i.pid||(i.pid=this.params.pid),i.dtype="stred",["/jclck/",new t.Query(r).toString("/",!0,e.ENCODE_EXCEPT_PARAMS),new t.Query(i).toString("/",!0,e.ENCODE_EXCEPT_PARAMS),"*",this._getAsterixData(n)].join("")},i._getRnd=function(t){return(new Date).getTime()+Math.floor(Math.random()*Math.pow(10,t))},i._getAsterixData=function(t){return t?"data="+encodeURIComponent("url="+t):""},e.ENCODE_EXCEPT_PARAMS=["reqid","path","yuid","login"]}),Sandbox.decl({LOGGED_PLAYER_EVENTS:["inited","started","ended","paused","error","resumed","rewound","adShown","adEnd"],init:function(){if(this._playbackCountersError=this.validateCountersParams(this.counters),this._playbackCountersError)return void this._logError(this._playbackCountersError);this.counters.live&&(this.counters.duration=0);var t=this.counters.heartbeats=this.counters.heartbeats||{};t.singlePath=t.singlePath||"heartbeat.single",t.repeatPath=t.repeatPath||"heartbeat.repeat",this.counters.pid=this.counters.pid||197,this.counters.clickId=(new Date).getTime(),this.counters.selectEvent=this.counters.selectEvent||"default",this.counters.extraParams=this.counters.extraParams||{},this.yaCounter=new Sandbox.Counter(this.counters),Sandbox.Timer.onTick(this.onTick,this);var e=this.calcHbSingleInterval(this.counters.duration),i=this.calcHbRepeatInterval(this.counters.duration);if(this.timers={single:new Sandbox.Timer(e,!1).onAlarm(this.onHeartbeatSingle,this),repeat:new Sandbox.Timer(i,!0).onAlarm(this.onHeartbeatRepeat,this)},this.prevEventTrigger(),!this.PLAYER_EVENTS_SUPPORTED){this.PLAYER_EVENTS_SUPPORTED=!1;var n=Math.round(((new Date).getTime()-Sandbox.INIT_TIME)/1e3);Sandbox.Timer.init(n),Sandbox.Timer.start()}},validateCountersParams:function(t){return Sandbox.isObject(t)?t.reqid?t.live||Sandbox.isNumber(t.duration)&&!(t.duration<=0)?"":"В данных для счётчиков некорректный duration":"В данных для счётчиков отсутствует reqid":"Отсутствуют параметры счётчиков"},prevEventTrigger:function(){if(Array.isArray(this.eventsStory))for(var t=0;t<this.eventsStory.length;t++)this.onPlayerEventForCounters.apply(this,this.eventsStory[t]);this.eventsStory=[]},rememberEvent:function(){this.onPlayerEventForCounters.apply(this,arguments)},calcHbSingleInterval:function(t){return t?Math.floor(Math.min(.5*t,300+2e5/t)):0},calcHbRepeatInterval:function(t){return t?Math.floor(Math.max(.1*t,30)):30},getCounterParams:function(){var t={click_id:this.counters.clickId,select_event:this.counters.selectEvent,duration:Math.round(this.counters.duration),client_timestamp:Date.now(),cts:Date.now(),jsapi:this.PLAYER_EVENTS_SUPPORTED?1:0};this.counters.videoUrl&&(t.source_url=this.counters.videoUrl),this.counters.licence&&(t.licence=this.counters.licence),Sandbox.isUndefined(this.counters.watchedTime)||(t.watchedTime=this.counters.watchedTime);var e=this.counters.extraParams;for(var i in e)e.hasOwnProperty(i)&&!t[i]&&(t[i]=e[i]);return t},prepareHeartbeatPath:function(t){return document.hidden&&(t+=".inactive-tab"),t},hitPixels:function(t){if(!this._playbackCountersError&&Array.isArray(t))for(var e=0;e<t.length;e++)this.yaCounter.hit(t[e],this.counters.videoUrl)},onTick:function(t){if(this.counters.live&&this.counters.duration<t&&(this.counters.duration=t+10),t>this.counters.duration)return void Sandbox.Timer.disable();this.trigger("timerTick",{ticks:t})},onHeartbeatSingle:function(t){if(!(this._playbackCountersError||t>this.counters.duration)){var e=this.getCounterParams();e.path=this.prepareHeartbeatPath(this.counters.heartbeats.singlePath),e.cid=72339,e.ticks=t,e.login=!0,this.yaCounter.hit(e,this.counters.videoUrl),this.hitPixels(this.counters.heartbeats.singlePixels),this.trigger("heartbeatSingleHit",{ticks:t})}},onHeartbeatRepeat:function(t){if(!(this._playbackCountersError||t>this.counters.duration)){var e=this.getCounterParams();e.path=this.prepareHeartbeatPath(this.counters.heartbeats.repeatPath),e.cid=72339,e.ticks=t,e.login=!0,this.yaCounter.hit(e,this.counters.videoUrl),this.hitPixels(this.counters.heartbeats.repeatPixels),this.trigger("heartbeatRepeatHit",{ticks:t})}},onPlayerEventForCounters:function(t,e){if(!this._playbackCountersError){switch(t){case"started":case"resumed":this.PLAYER_EVENTS_SUPPORTED=!0,Sandbox.Timer.start();break;case"paused":case"ended":this.PLAYER_EVENTS_SUPPORTED=!0,Sandbox.Timer.stop();break;case"timeupdate":this.counters.watchedTime=e?e.utcTime:0;break;case"durationchange":this.counters.duration=e?e.duration:0}this.LOGGED_PLAYER_EVENTS.indexOf(t)>-1&&this.hitPlayerEventCounter(t,e)}},hitPlayerEventCounter:function(t,e){if(!this._playbackCountersError){var i=this.getCounterParams();i.cid=73037,i.path="player-events."+t,e&&!Sandbox.isUndefined(e.isMuted)&&(i.mute=e.isMuted?1:0),e&&e.time&&(i.time=e.time),e&&e.code&&(i.code=e.code),e&&e.source&&(i.source=e.source),this.yaCounter.hit(i,this.counters.videoUrl)}},_logError:function(t){this.counters&&this.counters.debug&&window.console&&window.console.error&&console.error(t)}});